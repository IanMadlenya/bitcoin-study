#!/usr/bin/env ruby

require 'sinatra'

order_book = {
  bids: [
    [ 584.51, 0.051 ],
    [ 584.11, 2.38236613 ],
    [ 583.9, 10.08225244 ],
    [ 583, 18.007082320000002 ],
    [ 582.02, 24.392193040000002 ],
    [ 582, 36.39910449 ],
    [ 581.29, 39.423041080000004 ],
    [ 581.03, 54.430039369999996 ],
    [ 580.07, 81.42240225 ],
    [ 580, 82.01710269 ],
    [ 579, 110.05718672 ],
    [ 577.59, 177.06307658 ],
    [ 575.14, 168.95210489999997 ],
    [ 574.2, 185.31271258 ],
    [ 572.5, 238.34821356000003 ],
    [ 571.5, 229.71424693000003 ],
    [ 568.75, 258.73490532 ],
    [ 566, 326.37605882 ],
    [ 562.5, 324.7133431099998 ],
    [ 560, 472.5636382600001 ],
    [ 555, 423.71029108000005 ],
    [ 552, 1412.75300527 ],
    [ 549.36, 498.3625574099999 ],
    [ 538.84, 529.5586012800001 ],
    [ 530.5, 624.2372472200001 ],
    [ 525.12, 642.13880772 ],
    [ 517, 986.5255863599998 ],
    [ 506.01, 738.33068118 ],
    [ 505, 1167.76258314 ],
    [ 501, 1067.98515022 ],
    [ 490, 932.8048522999999 ],
    [ 475.85, 968.6992985399999 ],
    [ 464.12, 1114.6753908 ],
    [ 461.7, 1438.8101975900001 ],
    [ 450.03, 1158.2296833599999 ],
    [ 427.2, 1225.6820699199986 ],
    [ 410, 1391.2979606799997 ],
    [ 400, 2105.71619236 ],
    [ 380, 1655.89963851 ],
    [ 358.29, 1535.3660540099995 ],
    [ 351.13, 1602.5898242499998 ],
    [ 341.71, 1719.62399581 ],
    [ 321.17, 2628.38928665 ],
    [ 311.54, 1865.71803399 ],
    [ 300, 2485.7578385999996 ],
    [ 282.04, 2286.53096275 ],
    [ 263.54, 2788.10881178 ],
    [ 242.83, 2684.4854600099998 ],
    [ 222.22, 2373.5731808400005 ],
    [ 202.02, 2520.92138346 ],
    [ 190.78, 3069.6956441199995 ],
    [ 162.89, 3421.7858106099998 ],
    [ 124, 2731.0973581599987 ],
    [ 100, 4410.0416247699995 ],
    [ 61.11, 3005.07432496 ],
    [ 11.1, 12841.82079921 ],
    [ 1.23, 3250.5743782 ],
    [ 1, 14517.79804881 ],
    [ 0.16, 7120.374 ],
    [ 0.05, 4234.139999999999 ],
    [ 0.01, 44910 ]
  ],
  asks: [
    [ 586.5, 2.55175 ],
    [ 587.45, 10.59201951 ],
    [ 587.49, 11.04255608 ],
    [ 587.72, 24.52269611 ],
    [ 587.74, 160.40639268 ],
    [ 588, 104.37864556000001 ],
    [ 589, 125.06239971000001 ],
    [ 589.59, 172.62649965 ],
    [ 589.65, 74.67 ],
    [ 590, 129.59360938999998 ],
    [ 594.95, 210.45988905000002 ],
    [ 594.99, 151.83600308 ],
    [ 597.68, 158.52849483 ],
    [ 598, 227.78766736 ],
    [ 599, 436.44043805 ],
    [ 603, 228.20832178999999 ],
    [ 605, 500.53205505 ],
    [ 610, 373.14077236 ],
    [ 615, 415.9758644699999 ],
    [ 619.6, 361.8061149399998 ],
    [ 620, 491.84976770000003 ],
    [ 627.62, 702.3983365900001 ],
    [ 637.12, 495.45883456999974 ],
    [ 643.97, 583.3059606500001 ],
    [ 648.99, 577.81644747 ],
    [ 660, 659.5047789599998 ],
    [ 678, 678.4466173499997 ],
    [ 700, 823.20966636 ],
    [ 710, 789.27214365 ],
    [ 750, 855.0531966 ],
    [ 799.99, 919.01786047 ],
    [ 825, 981.1295989199997 ],
    [ 850, 1200.19750019 ],
    [ 925, 1097.8484338199999 ],
    [ 995.98, 1203.3752902100005 ],
    [ 1033, 1347.6087709999988 ],
    [ 1217, 1315.5626335000002 ]
  ]
}

get '/' do
  erb :index
end

get '/data.tsv' do
  out = ["price\tbid\task"]
  cum_vol = 0
  out += order_book[:bids].map do |p, v|
    cum_vol += v
    "#{p}\t#{cum_vol}\t0"
  end.reverse
  cum_vol = 0
  order_book[:asks].each do |p, v|
    cum_vol += v
    out << "#{p}\t0\t#{cum_vol}"
  end
  out.join("\n")
end